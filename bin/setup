#!/usr/bin/env ruby
# frozen_string_literal: true
require 'pathname'
require_relative '../config/boot'
require 'gumboot/strap'
include Gumboot::Strap
require 'fileutils'
include FileUtils

APP_ROOT = Pathname.new File.expand_path('../../', __FILE__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

chdir APP_ROOT do
  puts '== Installing dependencies =='
  system! 'gem install bundler --conservative'
  system('bundle check') || system!('bundle install')

  puts "\n== Loading Rails environment =="

  require_relative '../config/environment'

  system('rake db:drop:all') unless Rails.env.production?

  ensure_activerecord_databases(%w(test development))
  maintain_activerecord_schema
  load_seeds

  clean_logs
  clean_tempfiles

  puts "\n== Restarting application server =="
  system! 'bin/rails restart'
end
